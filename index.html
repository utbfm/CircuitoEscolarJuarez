<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Carte OpenStreetMap avec points GPS dynamiques</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
        }
        #map {
            flex-grow: 1;
            width: 100%;
            min-height: 300px;
        }
        .leaflet-control-attribution {
            display: none !important;
        }
        #header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: #FE8304;
            color: black;
            padding: 20px;
            margin: 0;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            z-index: 1000;
        }
        #datetime {
            position: absolute;
            top: 100px;
            left: 10px;
            background: rgba(255, 255, 255, 0.7);
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 1000;
            font-weight: bold;
        }
        .leaflet-control-zoom {
            position: relative;
            top: 130px;
        }
        #footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #FE8304;
            padding: 20px;
            color: white;
            font-weight: bold;
            text-align: right;
            z-index: 1000;
        }
        .bus-label {
            color: black;
            font-weight: bold;
            text-shadow: 1px 1px white, -1px -1px white, 1px -1px white, -1px 1px white;
        }
    </style>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <div id="header">SUPERVISI√ìN DEL CIRCUITO ESCOLAR JU√ÅREZ NL</div>
    <div id="datetime"></div>
    <div id="map"></div>
    <div id="footer">¬© 2025 UTBFM Ju√°rez N.L.</div>
    <script>
        function updateDateTime() {
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const dateTimeStr = `${day}/${month}/${year} ${hours}:${minutes}`;
            document.getElementById('datetime').textContent = dateTimeStr;
        }

        var map = L.map('map').setView([25.64107090227007, -100.10760242812114], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        updateDateTime();
        setInterval(updateDateTime, 60000);

        function addSchoolSymbol(lat, lon, symbolText, labelText) {
            const size = 18;
            L.marker([lat, lon], {
                icon: L.divIcon({
                    html: `<div style="font-size: ${size}px;">${symbolText}</div>`,
                    iconSize: [size, size],
                    iconAnchor: [size / 2, size / 2],
                    className: 'custom-div-icon'
                })
            }).addTo(map).bindPopup(labelText);
        }

        addSchoolSymbol(25.63792851629281, -100.04780921128857, 'üéì', 'UTBFM');
        addSchoolSymbol(25.649170044873816, -100.0731744270799, 'üéì', 'CONALEP');
        addSchoolSymbol(25.64790911216649, -100.08567360597452, 'üéì', 'CECYTE');
        addSchoolSymbol(25.6451092046172, -100.08807434460095, 'üéì', 'Preparatoria 22');
        addSchoolSymbol(25.604463257832606, -100.10461550597647, 'üéì', 'Unidad Acad√©mica');

        async function fetchRoute(coordinates) {
            const osrmUrl = `https://router.project-osrm.org/route/v1/driving/`;
            const coordinatesString = coordinates.map(coord => coord.join(',')).join(';');
            const url = `${osrmUrl}${coordinatesString}?overview=full`;

            try {
                console.log('Fetching route from:', url);
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error: ${response.status}`);
                }
                const data = await response.json();
                console.log('Route data:', data);
                const route = data.routes[0].geometry;
                return decodePolyline(route);
            } catch (err) {
                console.error('Error fetching route:', err);
            }
        }

        function decodePolyline(polyline) {
            let index = 0, lat = 0, lng = 0, points = [];
            const shift = 0x20, mask = ~shift;

            for (let i = 0; i < polyline.length; i++) {
                let byte, sum = 0, shiftCount = 0;
                do {
                    byte = polyline.charCodeAt(index++) - 63;
                    sum |= (byte & mask) << shiftCount;
                    shiftCount += 5;
                } while (byte >= shift);

                const delta = (sum & 1) ? ~(sum >> 1) : (sum >> 1);
                lat += delta;
                sum = 0; shiftCount = 0;
                do {
                    byte = polyline.charCodeAt(index++) - 63;
                    sum |= (byte & mask) << shiftCount;
                    shiftCount += 5;
                } while (byte >= shift);

                const deltaLng = (sum & 1) ? ~(sum >> 1) : (sum >> 1);
                lng += deltaLng;
                points.push([lat / 1e5, lng / 1e5]);
            }
            return points;
        }

        async function drawRouteOnMap(coordinates) {
            const routeCoordinates = await fetchRoute(coordinates);
            if (routeCoordinates) {
                L.polyline(routeCoordinates, {color: 'blue'}).addTo(map);
            }
        }

        const coordinates = [
            [25.638644282181144, -100.0475409887724],
            [25.639155, -100.052001],
            [25.639859, -100.053821],
            [25.640219, -100.054835],
            [25.64098, -100.056557],
            [25.64181, -100.057367],
            [25.642808, -100.058271],
            [25.643748, -100.059105],
            [25.644284, -100.059913],
            [25.644681, -100.060902],
            [25.645975, -100.062918],
            [25.646794, -100.064365],
            [25.647349, -100.065385],
            [25.648781, -100.067662],
            [25.648882, -100.068966],
            [25.649262, -100.071203],
            [25.64973, -100.072065],
            [25.650088, -100.072725],
            [25.650484, -100.073459],
            [25.65092, -100.074177],
            [25.651524, -100.075169],
            [25.652286, -100.076025],
            [25.652724, -100.076675],
            [25.653543, -100.078179],
            [25.654079, -100.0793],
            [25.654749, -100.080438],
            [25.654757, -100.080454],
            [25.654757, -100.080453],
            [25.654757, -100.080452],
            [25.654756, -100.080452],
            [25.654694, -100.081059],
            [25.652481, -100.082373],
            [25.650872, -100.083322],
            [25.649067, -100.084382],
            [25.647737, -100.085216],
            [25.645493, -100.086489],
            [25.644265, -100.087315],
            [25.642228, -100.088465],
            [25.641106, -100.089097],
            [25.641086, -100.089131],
            [25.640842, -100.089344],
            [25.640471, -100.090491]
        ];

        drawRouteOnMap(coordinates);
    </script>
</body>
</html>
