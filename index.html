<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supervisión del Circuito Escolar</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
        }
        #header {
            background-color: #ff6200;
            color: white;
            text-align: center;
            padding: 10px;
            font-size: 24px;
        }
        #map {
            flex: 1;
            position: relative;
        }
        #footer {
            background-color: #ff6200;
            color: white;
            text-align: center;
            padding: 5px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="header">SUPERVISIÓN DEL CIRCUITO ESCOLAR</div>
    <div id="map"></div>
    <div id="footer">© 2025 UTBFM Juárez N.L.</div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialisation de la carte
        const map = L.map('map').setView([25.64921833, -100.0700464], 13); // Coordonnées initiales
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // Marqueurs fixes du circuit scolaire
        const circuitPoints = [
            { name: "CECYTE", coords: [25.648, -100.07] },
            { name: "UTBFM", coords: [25.65, -100.068] },
            { name: "Preparatoria 22 UANL", coords: [25.652, -100.072] },
            { name: "Unidad Académica Juárez UANL", coords: [25.647, -100.074] }
        ];

        circuitPoints.forEach(point => {
            L.marker(point.coords, { icon: L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png', iconSize: [25, 41], iconAnchor: [12, 41] }) })
                .addTo(map)
                .bindPopup(point.name);
        });

        // Polyligne pour le circuit
        const circuitPath = circuitPoints.map(p => p.coords);
        L.polyline(circuitPath, { color: '#ff6200' }).addTo(map);

        // Marqueur du bus (initialisé mais mis à jour dynamiquement)
        let marker;

        // Fonction pour mettre à jour le marqueur du bus
        function updateMarker(lat, lon) {
            console.log('updateMarker appelé avec:', lat, lon);
            const coords = [lat, lon];
            if (marker) {
                marker.setLatLng(coords);
            } else {
                marker = L.marker(coords, { icon: L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png', iconSize: [25, 41], iconAnchor: [12, 41] }) }).addTo(map);
            }
            map.panTo(coords);
        }

        // Fonction pour récupérer les coordonnées GPS
        async function fetchGPSData() {
            try {
                const sheetUrl = 'https://docs.google.com/spreadsheets/d/19ktCE0XtzOt7Kbov5hUXRrA9fVxi2VqBT3M86Agj0GI/export?format=csv&gid=2017613525';
                console.log('Tentative de fetch avec URL:', sheetUrl);
                const response = await fetch(sheetUrl);
                console.log('Réponse status:', response.status);
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                const text = await response.text();
                console.log('CSV reçu:', text);
                const lines = text.trim().split('\n');
                console.log('Lignes CSV:', lines);
                if (lines.length < 2) {
                    throw new Error('Aucune donnée disponible dans le CSV');
                }
                const lastLine = lines[lines.length - 1].split(',');
                console.log('Dernière ligne:', lastLine);
                const lat = parseFloat(lastLine[5]); // Latitude à l'index 5
                const lon = parseFloat(lastLine[4]); // Longitude à l'index 4
                console.log('Coordonnées extraites:', { lat, lon });
                if (!isNaN(lat) && !isNaN(lon)) {
                    updateMarker(lat, lon);
                    console.log('Marqueur mis à jour à:', lat, lon);
                } else {
                    console.warn('Coordonnées GPS invalides:', lastLine);
                }
            } catch (err) {
                console.error('Erreur lors de la récupération des coordonnées GPS:', err);
            }
        }

        // Appel initial et mise à jour périodique
        fetchGPSData(); // Appel initial
        setInterval(fetchGPSData, 5000); // Mise à jour toutes les 5 secondes
    </script>
</body>
</html>
